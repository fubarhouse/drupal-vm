---

- name: Looking for GoAccess
  stat:
    path: /usr/local/bin/goaccess
  register: goaccess_stat

- name: Ensure GoAccess dependencies are installed
  package:
    name: "{{ item }}"
    state: installed
  with_items:
    - libgeoip-dev
    - libncursesw5-dev
  when: goaccess_stat.stat.exists|bool == false

- name: Create Directory for GoAccess
  file:
    path: /opt/goaccess-1.2
    state: directory
    mode: 0775
  when: goaccess_stat.stat.exists|bool == false

- name: Download GoAccess
  unarchive:
    src: http://tar.goaccess.io/goaccess-1.2.tar.gz
    dest: /opt/
    remote_src: yes
  when: goaccess_stat.stat.exists|bool == false

- name: Make GoAccess
  command: "{{ item }}"
  args:
    chdir: '/opt/goaccess-1.2/'
  with_items:
    - ./configure --enable-utf8 --enable-geoip=legacy
    - make
    - make install
  when: goaccess_stat.stat.exists|bool == false

- name: Configure GoAcccess for Apache
  lineinfile:
    path: /usr/local/etc/goaccess.conf
    regexp: '{{ item.regex|regex_escape() }}'
    line: '{{ item.replace }}'
    backrefs: yes
    state: present
  with_items:
    - regex: '#time-format %H:%M:%S'
      replace: 'time-format %H:%M:%S'
    - regex: '#date-format %d/%b/%Y'
      replace: 'date-format %d/%b/%Y'
    - regex: 'log-format %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
      replace: '#log-format %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
    - regex: '#log-format %v:%^ %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
      replace: 'log-format %v:%^ %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
  when: 'drupalvm_webserver == "apache"'

- name: Configure GoAcccess for NGINX
  lineinfile:
    path: /usr/local/etc/goaccess.conf
    regexp: '{{ item.regex|regex_escape() }}'
    line: '{{ item.replace }}'
    backrefs: yes
    state: present
  with_items:
    - regex: '#time-format %H:%M:%S'
      replace: 'time-format %H:%M:%S'
    - regex: '#date-format %d/%b/%Y'
      replace: 'date-format %d/%b/%Y'
    - regex: '#log-format %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
      replace: 'log-format %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
    - regex: 'log-format %v:%^ %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
      replace: '#log-format %v:%^ %h %^[%d:%t %^] "%r" %s %b "%R" "%u"'
  when: 'drupalvm_webserver == "nginx"'

- name: Create folder for GoAccess output
  file:
    path: "{{ goaccess_install_dir }}"
    state: directory
    mode: 0777

- name: Ensure GoAccess cron task is present for Apache
  cron:
    name: "Update GoAccess data"
    state: present
    job: "goaccess /var/log/apache2/access.log -o {{ goaccess_install_dir }}/index.html"
  when: 'drupalvm_webserver == "apache"'

- name: Ensure GoAccess cron task is present for NGINX
  cron:
    name: "Update GoAccess data"
    state: present
    job: "goaccess /var/log/nginx/access.log -o {{ goaccess_install_dir }}/index.html"
  when: 'drupalvm_webserver == "nginx"'
